<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced ID Verification Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .scanner-container {
            width: 100%;
            max-width: 500px;
            margin: auto;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-width: 500px;
            text-align: center;
            transform: scale(0.95);
            transition: all 0.3s ease;
        }
        .modal:not(.hidden) .modal-content {
            transform: scale(1);
        }
        .hidden {
            display: none;
        }
        .gemini-btn {
            background-color: #8E44AD; /* A nice purple for Gemini features */
            color: white;
        }
        .gemini-btn:hover {
            background-color: #7D3C98;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">ಮಲ್ಲಿಗೆ ನಾಡಿನ ಛಾಯಾಗ್ರಹಕರ ಸಂಘ (ರಿ) ಹೂವಿನಹಡಗಲಿ</h1>
        <h2 class="text-3xl font-bold text-gray-800">Enhanced ID Verification</h2>
            <p class="text-gray-500 mt-2">Leveraging AI for secure and reliable verification.</p>
        </div>

        <!-- Verification Options -->
        <div id="options-container">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Manual Entry -->
                <div id="manual-option" class="p-6 border border-gray-200 rounded-lg text-center hover:shadow-lg transition-shadow cursor-pointer">
                    <svg class="w-12 h-12 mx-auto text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                    <h3 class="text-lg font-semibold mt-4 text-gray-700">Enter Manually</h3>
                </div>
                <!-- QR Code Scanner -->
                <div id="qr-option" class="p-6 border border-gray-200 rounded-lg text-center hover:shadow-lg transition-shadow cursor-pointer">
                    <svg class="w-12 h-12 mx-auto text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h-1m-1 6v-1M4 12H3m1-6h1M8 8h8v8H8z"></path><path d="M7 7h1v1H7zM7 16h1v1H7zM16 7h1v1h-1zM16 16h1v1h-1z"></path></svg>
                    <h3 class="text-lg font-semibold mt-4 text-gray-700">Scan QR Code</h3>
                </div>
                <!-- Image Upload -->
                <div id="upload-option" class="p-6 border border-gray-200 rounded-lg text-center hover:shadow-lg transition-shadow cursor-pointer bg-indigo-50">
                     <svg class="w-12 h-12 mx-auto text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <h3 class="text-lg font-semibold mt-4 text-gray-700">✨ Smart Scan ID Image</h3>
                </div>
            </div>
        </div>

        <!-- Verification Sections -->
        <div id="verification-sections" class="mt-8">
            <!-- Manual Input Section -->
            <div id="manual-section" class="hidden">
                <h2 class="text-2xl font-semibold mb-4 text-center">Manual Verification</h2>
                <div class="flex flex-col items-center">
                    <input type="text" id="reg-number-input" placeholder="Enter Registration Number" class="w-full max-w-md p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                    <button id="verify-manual-btn" class="mt-4 w-full max-w-md bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Verify</button>
                    <button class="back-btn mt-2 text-gray-500 hover:text-gray-700">Back</button>
                </div>
            </div>

            <!-- QR Scanner Section -->
            <div id="qr-section" class="hidden">
                <h2 class="text-2xl font-semibold mb-4 text-center">Scan QR Code</h2>
                <div class="scanner-container">
                    <div id="qr-reader" class="w-full"></div>
                </div>
                 <div class="text-center">
                    <button class="back-btn mt-4 text-gray-500 hover:text-gray-700">Back</button>
                </div>
            </div>

            <!-- Image Upload Section -->
            <div id="upload-section" class="hidden">
                 <h2 class="text-2xl font-semibold mb-4 text-center">✨ Smart Scan ID Card Image</h2>
                 <div class="flex flex-col items-center">
                    <div class="w-full max-w-md p-6 border-2 border-dashed border-gray-300 rounded-lg text-center">
                        <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                        <label for="image-upload-input" class="cursor-pointer">
                            <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V6a4 4 0 014-4h12a4 4 0 014 4v6a4 4 0 01-4 4H7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 16v-4a4 4 0 00-4-4H8a4 4 0 00-4 4v4"></path></svg>
                            <p class="mt-2 text-sm text-gray-600">Click to upload or drag and drop</p>
                            <p class="text-xs text-gray-500">PNG, JPG up to 10MB</p>
                        </label>
                        <div id="image-preview-container" class="mt-4 hidden">
                            <img id="image-preview" src="#" alt="Image Preview" class="max-h-48 mx-auto rounded-lg"/>
                            <p id="file-name" class="text-sm text-gray-500 mt-2"></p>
                        </div>
                    </div>
                    <button id="verify-upload-btn" class="mt-4 w-full max-w-md bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors disabled:bg-gray-400" disabled>✨ Scan Image</button>
                    <button class="back-btn mt-2 text-gray-500 hover:text-gray-700">Back</button>
                 </div>
            </div>
        </div>
    </div>

    <!-- Modal for results and loading -->
    <div id="result-modal" class="modal hidden">
        <div class="modal-content">
            <div id="modal-loading" class="hidden">
                <svg class="animate-spin h-10 w-10 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="loading-message" class="mt-4 text-lg font-medium text-gray-700">Verifying...</p>
            </div>
            <div id="modal-result">
                <h3 id="modal-title" class="text-2xl font-bold"></h3>
                <p id="modal-message" class="mt-2 text-gray-600"></p>
                <div id="gemini-actions" class="mt-4 space-y-2"></div>
                <div id="gemini-results" class="mt-4 p-3 bg-gray-50 rounded-lg text-left text-sm hidden"></div>
                <button id="modal-close-btn" class="mt-6 w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const optionsContainer = document.getElementById('options-container');
        const verificationSections = document.getElementById('verification-sections');
        const manualOption = document.getElementById('manual-option');
        const qrOption = document.getElementById('qr-option');
        const uploadOption = document.getElementById('upload-option');
        const manualSection = document.getElementById('manual-section');
        const qrSection = document.getElementById('qr-section');
        const uploadSection = document.getElementById('upload-section');
        const backBtns = document.querySelectorAll('.back-btn');
        const regNumberInput = document.getElementById('reg-number-input');
        const verifyManualBtn = document.getElementById('verify-manual-btn');
        const imageUploadInput = document.getElementById('image-upload-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const fileName = document.getElementById('file-name');
        const verifyUploadBtn = document.getElementById('verify-upload-btn');
        const resultModal = document.getElementById('result-modal');
        const modalLoading = document.getElementById('modal-loading');
        const loadingMessage = document.getElementById('loading-message');
        const modalResult = document.getElementById('modal-result');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const geminiActions = document.getElementById('gemini-actions');
        const geminiResults = document.getElementById('gemini-results');

        let html5QrCode;
        let currentVerificationData = {};

        // --- Navigation Logic ---
        const showSection = (section) => {
            optionsContainer.classList.add('hidden');
            verificationSections.classList.remove('hidden');
            [manualSection, qrSection, uploadSection].forEach(s => s.classList.add('hidden'));
            section.classList.remove('hidden');
        };

        const showOptions = () => {
            optionsContainer.classList.remove('hidden');
            verificationSections.classList.add('hidden');
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Failed to stop QR scanner:", err));
            }
        };

        manualOption.addEventListener('click', () => showSection(manualSection));
        qrOption.addEventListener('click', () => {
            showSection(qrSection);
            startQrScanner();
        });
        uploadOption.addEventListener('click', () => showSection(uploadSection));
        backBtns.forEach(btn => btn.addEventListener('click', showOptions));

        // --- Modal Logic ---
        const showModal = (isLoading = false, title = '', message = '') => {
            resultModal.classList.remove('hidden');
            geminiActions.innerHTML = '';
            geminiResults.classList.add('hidden');
            geminiResults.innerHTML = '';
            if (isLoading) {
                modalLoading.classList.remove('hidden');
                modalResult.classList.add('hidden');
            } else {
                modalLoading.classList.add('hidden');
                modalResult.classList.remove('hidden');
                modalTitle.textContent = title;
                modalMessage.innerHTML = message;
            }
        };

        const hideModal = () => {
            resultModal.classList.add('hidden');
            showOptions();
        };
        modalCloseBtn.addEventListener('click', hideModal);

        // --- Main Verification Logic ---
        const performVerification = async (type, data) => {
            loadingMessage.textContent = "Verifying...";
            showModal(true);
            await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate initial check

            let success = false;
            let details = '';
            let extractedText = '';
            currentVerificationData = { type, data };

            if (type === 'manual' || type === 'qr') {
                const validIds = ['12345', 'ABC-DEF', 'USER-999'];
                if (validIds.includes(data)) {
                    success = true;
                    details = Registration Number: <strong>${data}</strong><br>Status: Verified<br>Name: John Doe;
                } else {
                    details = Registration Number: <strong>${data}</strong><br>Status: Not Found;
                }
            } else if (type === 'image') {
                loadingMessage.textContent = "✨ Analyzing Image with AI...";
                try {
                    extractedText = await callGeminiVisionAPI(data);
                    const validIds = ['12345', 'ABC-DEF', 'USER-999'];
                    const foundId = validIds.find(id => extractedText.toLowerCase().includes(id.toLowerCase()));
                    
                    if (foundId) {
                        success = true;
                        details = ID Found in Image: <strong>${foundId}</strong><br>Status: Verified<br>Name: Jane Smith (extracted by AI);
                        currentVerificationData.extractedText = extractedText;
                    } else {
                         details = Could not verify the ID from the uploaded image. <br><strong class="text-sm">AI Analysis Result:</strong><br><em class="text-xs text-gray-500">${extractedText.substring(0, 150)}...</em>;
                    }
                } catch (error) {
                    console.error("Error analyzing image:", error);
                    details = "An error occurred during AI image analysis. Please try again.";
                }
            }

            if (success) {
                showModal(false, '✅ Verification Successful', details);
                addGeminiButtons(type);
            } else {
                showModal(false, '❌ Verification Failed', details);
            }
        };

        // --- Add Gemini Action Buttons ---
        function addGeminiButtons(type) {
            geminiActions.innerHTML = ''; // Clear previous buttons
            
            if (type === 'image') {
                const fraudBtn = document.createElement('button');
                fraudBtn.innerHTML = '✨ Check for Fraud';
                fraudBtn.className = 'w-full gemini-btn py-2 rounded-lg font-semibold transition-colors';
                fraudBtn.onclick = handleFraudCheck;
                geminiActions.appendChild(fraudBtn);
            }

            const summaryBtn = document.createElement('button');
            summaryBtn.innerHTML = '✨ Generate Verification Summary';
            summaryBtn.className = 'w-full gemini-btn py-2 rounded-lg font-semibold transition-colors';
            summaryBtn.onclick = handleSummaryGeneration;
            geminiActions.appendChild(summaryBtn);
        }

        // --- Handlers for Gemini Actions ---
        async function handleFraudCheck() {
            loadingMessage.textContent = '🕵‍♂ Analyzing for fraud...';
            modalLoading.classList.remove('hidden');
            geminiActions.classList.add('hidden');

            try {
                const prompt = Analyze the following ID card image and its extracted text. Does the image appear to be digitally altered, photoshopped, or fraudulent? Look for inconsistencies in fonts, lighting, text alignment, and photo quality. Provide a brief analysis and a confidence score for fraud risk (Low, Medium, High). Extracted text for context: "${currentVerificationData.extractedText}";
                const result = await callGeminiVisionAPI(currentVerificationData.data, prompt);
                geminiResults.innerHTML = <strong>Fraud Analysis:</strong><p>${result.replace(/\n/g, '<br>')}</p>;
                geminiResults.classList.remove('hidden');
            } catch (error) {
                geminiResults.innerHTML = '<strong>Error:</strong> Could not perform fraud analysis.';
                geminiResults.classList.remove('hidden');
            } finally {
                modalLoading.classList.add('hidden');
            }
        }

        async function handleSummaryGeneration() {
            loadingMessage.textContent = '📝 Generating summary...';
            modalLoading.classList.remove('hidden');
            geminiActions.classList.add('hidden');

            try {
                const verificationDetails = Verification Method: ${currentVerificationData.type}, Verified Data: ${currentVerificationData.type === 'image' ? currentVerificationData.extractedText : currentVerificationData.data}, Timestamp: ${new Date().toString()};
                const prompt = Generate a brief, professional verification report for the following event: ${verificationDetails}. The report should be suitable for logging purposes.;
                const result = await callGeminiTextAPI(prompt);
                geminiResults.innerHTML = <strong>Verification Summary:</strong><p>${result.replace(/\n/g, '<br>')}</p>;
                geminiResults.classList.remove('hidden');
            } catch (error) {
                geminiResults.innerHTML = '<strong>Error:</strong> Could not generate summary.';
                geminiResults.classList.remove('hidden');
            } finally {
                modalLoading.classList.add('hidden');
            }
        }

        // --- Manual & QR Verification Triggers ---
        verifyManualBtn.addEventListener('click', () => {
            const regNumber = regNumberInput.value.trim();
            if (regNumber) performVerification('manual', regNumber);
        });

        function startQrScanner() {
            if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
            const qrSuccess = (text) => {
                if (html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => performVerification('qr', text));
                }
            };
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, qrSuccess)
                .catch(err => showModal(false, 'QR Error', 'Could not start camera.'));
        }

        // --- Image Upload & Verification Trigger ---
        imageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    fileName.textContent = file.name;
                    verifyUploadBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        });

        verifyUploadBtn.addEventListener('click', () => {
             if (imagePreview.src && imagePreview.src !== '#') {
                const base64Image = imagePreview.src.split(',')[1];
                performVerification('image', base64Image);
            }
        });
        
        // --- Gemini API Calls ---
        async function callGeminiAPI(payload) {
            // This function uses exponential backoff for retries.
            const apiKey = "AIzaSyBbDET-ncu2RyoEAh97Fh_57H9ccfTGc6I"; // Left empty, will be handled by the environment.
            const apiUrl = https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey};
            let response;
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                           throw new Error("Invalid response structure from API.");
                        }
                    } else if (response.status === 429 || response.status >= 500) {
                        // Throttled or server error, wait and retry
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        // Other client-side error, don't retry
                        throw new Error(API call failed with status: ${response.status});
                    }
                } catch (error) {
                    if (i === 4) throw error; // Rethrow last error
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            throw new Error("API call failed after multiple retries.");
        }

        async function callGeminiVisionAPI(base64ImageData, promptText = "Extract any registration numbers, names, or ID numbers from this image. Focus on structured data.") {
            const payload = {
              contents: [{
                  parts: [
                    { "text": promptText },
                    { "inline_data": { "mime_type": "image/jpeg", "data": base64ImageData } }
                  ]
              }]
            };
            return callGeminiAPI(payload);
        }

        async function callGeminiTextAPI(promptText) {
             const payload = {
              contents: [{ parts: [{ "text": promptText }] }]
            };
            return callGeminiAPI(payload);
        }

    </script>
</body>
</html>